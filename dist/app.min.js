var MyApp=angular.module("MyApp",["ui.router","leaflet-directive"]);MyApp.config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/intro"),e.state("main",{url:"/",templateUrl:"templates/main/main.html",controller:"MainController",controllerAs:"main"}).state("intro",{url:"/intro",templateUrl:"templates/intro/intro.html",controller:"IntroController",controllerAs:"intro"}).state("main.login",{url:"login",templateUrl:"templates/login/login.html"}).state("main.other",{url:"other",templateUrl:"templates/other/other.html"}).state("stuff",{url:"/stuff",templateUrl:"templates/stuff/stuff.html",controller:"StuffController",controllerAs:"stuffCtrl"})}]),MyApp.service("ApiService",["$http",function(e){this.syncMethod=function(){return 0},this.getThings=function(){return e.get(window.env.API_URL+"/stop").then(function(e){return e.data})["catch"](function(e){return console.error("Error ApiService getThings ",e),{}})},this.getTimetables=function(t){return e.get(window.env.API_URL+"/stop/"+t).then(function(e){return e.data})["catch"](function(e){return console.error("Error ApiService getTimetables ",e),{}})},this.getRoute=function(t,r){return e.get(window.env.API_URL+"/route/"+t.lat+"+"+t.lng+"+"+r.lat+"+"+r.lng).then(function(e){return e.data})["catch"](function(e){return console.error("Error ApiService getRoute ",e),{}})},this.getRouteByAddress=function(t,r){return console.log(window.env.API_URL+"/routes/"+t+"+"+r),e.get(window.env.API_URL+"/routes/"+t+"+"+r).then(function(e){return e.data})["catch"](function(e){return console.error("Error ApiService getRouteByAddress ",e),{}})},this.getAddress=function(t){return e.get(window.env.API_URL+"/origin/"+t.lat+","+t.lng).then(function(e){return e.data})["catch"](function(e){return console.error("Error ApiService getAddress ",e),{}})}}]),MyApp.controller("IntroController",["$scope","ApiService","PanelService","$http","leafletMarkerEvents","$window",function(e,t,r,n,o,a){var i=function(){e.frameHeight=a.innerHeight,e.frameWidth=a.innerWidth;var t=document.getElementById("map");t.style="height:"+e.frameHeight+"px; width:"+e.frameWidth+"px;"};i(),e.userMarker,t.getThings().then(function(t){e.stops=t}),e.map,e.userLocation,e.initMap=function(){e.map=L.map("map",{dragging:!0,tap:!1}),e.map.locate({watch:!0,setView:!0}),e.userLocation=e.map.locate()._initialCenter,L.tileLayer("https://api.digitransit.fi/map/v1/{id}/{z}/{x}/{y}.png",{maxZoom:16,minZoom:14,attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ',id:"hsl-map"}).addTo(e.map),e.map.on("locationfound",function(r){e.userLocation=r.latlng,e.addUserMarker(),t.getAddress(e.userLocation).then(function(e){document.getElementById("origin").value=e.features[0].properties.label})}),e.map.on("drag",function(t){e.addMarker()}),a.onresize=function(e){i()},e.map.on("zoomend",function(t){e.addMarker();for(var r=0;r<e.markers.length;r++)e.markers[r].setRadius(e.getRadiusByZoom())})},e.getRadiusByZoom=function(){var t,r=e.map.getZoom();switch(!0){case 17===r:t=8;break;case 16===r:t=6;break;case 15===r:t=3;break;case r<15&&r>=13:t=1}return t},e.distanceToDraw=function(){var t=e.map.getZoom();return 16===t?.004:15===t?.005:14===t?.009:void 0},e.drawnStop=[],e.markers=[],e.addMarker=function(){for(var r=e.map.getCenter(),n=e.distanceToDraw(),o=e.getRadiusByZoom(),a=0;a<e.stops.length;a++){var i=e.stops[a],p=i.coords.split(","),s=parseFloat(p[0]),l=parseFloat(p[1]);if(Math.abs(r.lat-s)<n&&Math.abs(r.lng-l)<2*n&&e.drawnStop.indexOf(i)===-1){var u=L.circleMarker([s,l],{color:e.colorByType(i.type)}).setRadius(o);u.bindPopup(L.popup({closeOnClick:!0}).setContent("<div class=spinner> <div class=double-bounce1></div> <div class=double-bounce2></div> </div>")),u.stopId=i.code,u.on("click",function(r){e.map.setView(r.latlng);var n=this;t.getTimetables(n.stopId).then(function(t){n._popup.setContent(e.createPopupContent(t))}),t.getRoute(e.userLocation,n._latlng).then(function(t){e.addRoute(t.data.plan.itineraries)})}),u.addTo(e.map),e.markers.push(u),e.drawnStop.push(i)}}},e.addUserMarker=function(){null!=e.userMarker&&e.map.removeLayer(e.userMarker),e.userMarker=L.circleMarker(e.userLocation,{color:"black"}).setRadius(8),e.userMarker.addTo(e.map),e.map.locate({watch:!0,setView:!1})},e.addRoute=function(t){if(null!=e.geoJSONLayers)for(var n=0;n<e.geoJSONLayers.length;n++)e.map.removeLayer(e.geoJSONLayers[n]);if(null!=e.routeTransferPopups)for(var n=0;n<e.routeTransferPopups.length;n++)e.map.removeLayer(e.routeTransferPopups[n]);e.routeTransferPopups=[],e.geoJSONLayers=[],e.routeInformation=[];for(var n=0;n<t.length;n++)for(var o=0;o<t[n].legs.length;o++){for(var a=[],i=0;i<t[n].legs[o].legGeometry.points.length;i++){var p=t[n].legs[o].legGeometry.points[i].split(",");a.push([p[1],p[0]])}var s=[{type:"LineString",coordinates:a}],l={color:r.routeColorByType(t[n].legs[o].mode),weight:5,opacity:.65},u=L.geoJson(s,{style:l}),d=!1;0===o&&t[n].legs[o].length>1&&(d=!0);var g={keepInView:!1,autoPan:d,closeOnClick:!1};e.routeInformation.push(t[n].legs[o]);var c=L.popup(g).setLatLng([t[n].legs[o].from.lat,t[n].legs[o].from.lon]).setContent(e.popupDepartureContent(t[n].legs[o]));e.routeTransferPopups.push(c),e.geoJSONLayers.push(u)}document.getElementById("routepanel").innerHTML=r.getPanelElements(e.routeInformation),e.heit=30+25*e.routeInformation.length+"px";for(var n=0;n<e.geoJSONLayers.length;n++)e.geoJSONLayers[n].addTo(e.map);for(var n=0;n<e.routeTransferPopups.length;n++)e.routeTransferPopups[n].addTo(e.map)},e.popupDepartureContent=function(e){if(null==e.startTime)return"<b style=margin:0px;padding:0px>"+Math.round(e.distance)+"m</b>";var t=new Date(e.startTime),n=t.getMinutes(),o=t.getHours();if(n<10)var n="0"+n;if(o<10)var o="0"+o;var a="<b style=margin:0px;padding:0px>"+o+":"+n+" </b>",i=r.routeColorByType(e.mode);return"WALK"===e.mode?a=a+"<b style=margin:0px;padding:0px;color:"+i+">walk </b>":null!=e.route.shortName?(a=a+"<b style=margin:0px;padding:0px;color:"+i+">"+e.route.shortName+"</b>",a=a+"<b style=margin:0px;padding:0px;> "+e.trip.tripHeadsign+"</b>"):"SUBWAY"===e.mode&&(a=a+"<b style=margin:0px;padding:0px;color:"+i+">M</b>",a=a+"<b style=margin:0px;padding:0px;> "+e.trip.tripHeadsign+"</b>"),a},e.colorByType=function(e){return"0"===e?"Green":"3"===e?"Blue":"1"===e?"Orange":"109"===e?"Purple":void 0},e.createPopupContent=function(t){if(null==t[0].departures)return"<b style=margin:0px;padding:0px>No departures to 2 hours </b>";for(var r="<b style=margin:0px;padding:0px>"+t[0].name_fi+"</b><p style=color:grey;margin:0px;padding:0px>"+t[0].address_fi+"<a style=margin:0px;padding:0px target=_blank href="+t[0].timetable_link+"> "+t[0].code_short+"</a></p>",n=0;n<t[0].departures.length;n++){var o=""+t[0].departures[n].time;if(r=r+"<b style=margin:0px;padding:0px>"+o.substr(0,2)+":"+o.substr(2,3)+"</b> "+e.parseBusNumber(t[0].departures[n].code,t[0].lines)+"<br>",n>4)break}return r},e.parseBusNumber=function(e,t){for(var r,n=0;n<t.length;n++)t[n].search(e)!==-1&&(r=t[n].split(":")[1]);return e=e.split(" ")[0],e.indexOf("M")!==-1?"<b style=margin:0px;padding:0px;color:orange> M </b> <span style=margin:0px;padding:0px>"+r+"</span>":"100"===e.substr(0,3)?"<b style=margin:0px;padding:0px;color:green> "+e.substr(3,e.toString().length)+"</b> <span style=margin:0px;padding:0px>"+r+"</span>":"1010"===e?"<b style=margin:0px;padding:0px;color:green> "+e.substr(2,e.toString().length)+"</b> <span style=margin:0px;padding:0px>"+r+"</span>":"10"===e.substr(0,2)?"<b style=margin:0px;padding:0px;color:blue;font-size:15px> "+e.substr(2,e.toString().length)+"</b> <span style=margin:0px;padding:0px>"+r+"</span>":"300"===e.substr(0,3)?"<b style=margin:0px;padding:0px;color:purple> "+e.substr(4,e.toString().length)+"</b> <span style=margin:0px;padding:0px>"+r+"</span>":"<b style=margin:0px;padding:0px;color:blue> "+e.substr(1,e.toString().length)+"</b> <span style=margin:0px;padding:0px>"+r+"</span>"},e.searchButtonEvent=function(){var r=document.getElementById("origin").value.replace("ä","a").replace("ö","o"),n=document.getElementById("destination").value.replace("ä","a").replace("ö","o");t.getRouteByAddress(r,n).then(function(t){e.addRoute(t.data.plan.itineraries)})},jQuery(function(e){e(".footer").on("click",function(){e("footer").slideToggle(200)})}),e.initMap(),document.documentElement.style.overflow="hidden"}]),MyApp.controller("LoginController",function(){}),MyApp.controller("MainController",["$scope",function(e){e.doStuff=function(){return"stuff"}}]),MyApp.service("PanelService",["$http",function(e){this.getPanelElements=function(e){for(var t="",r=0;r<e.length;r++){var n=e[r],o=new Date(n.startTime),a=new Date(n.endTime),i=o.getMinutes(),p=o.getHours(),s=a.getMinutes(),l=a.getHours();if(i<10)var i="0"+i;if(p<10)var p="0"+p;if(s<10)var s="0"+s;if(l<10)var l="0"+l;t=t+"<b style=margin:0px;padding:0px>"+p+":"+i+" </b>";var u=this.routeColorByType(n.mode);"WALK"===n.mode?(t=t+"<b style=margin:0px;padding:0px;color:"+u+">walk </b>",t=t+"<b style=margin:0px;padding:0px;> to "+n.to.name+"</b>"):null!=n.route.shortName?(t=t+"<b style=margin:0px;padding:0px;color:"+u+">"+n.route.shortName+"</b>",t=t+"<b style=margin:0px;padding:0px;> ("+n.trip.tripHeadsign+")</b>",t=t+"<b style=margin:0px;padding:0px;> to "+n.to.name+"</b>"):"SUBWAY"===n.mode&&(t=t+"<b style=margin:0px;padding:0px;color:"+u+">M</b>",t=t+"<b style=margin:0px;padding:0px;> "+n.trip.tripHeadsign+"</b>"),t=t+"<b id=endTime> "+l+":"+s+"</b><br>"}return t},this.routeColorByType=function(e){return"WALK"===e?"#00cc99":"BUS"===e?"#0066cc":"TRAM"===e?"#00cc00":"SUBWAY"===e?"DarkOrange":"RAIL"===e?"#cc00cc":"FERRY"===e?"Coral":"Grey"}}]),MyApp.controller("StuffController",function(){});
//# sourceMappingURL=app.min.js.map
